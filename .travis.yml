language: java

jdk:
  - oraclejdk8
  - oraclejdk7
  - openjdk7
  - openjdk6

before_install:
  - chmod +x gradlew

# see https://github.com/dmakhno/travis_after_all
script:
  # see https://github.com/dmakhno/travis_after_all/pull/1
  # -O writes it to a file named the same as the remote file name
  # $TRAVIS_REPO_SLUG expands to for example skiwi2/somerepo
  - curl -LO "https://raw.github.com/$TRAVIS_REPO_SLUG/$TRAVIS_BRANCH/travis_after_all.py"

after_success:
  - python travis_after_all.py
  - export $(cat .to_export_back)
  - |
      if [ "$BUILD_LEADER" = "YES" ]; then
        if [ "$BUILD_AGGREGATE_STATUS" = "others_succeeded" ]; then
          # TODO: call gradle uploadArchives with -P properties if branch == develop || branch == master
          echo "All Succeded! PUBLISHING..."
          if [[ ($TRAVIS_BRANCH = "master" && $TRAVIS_TAG) || $TRAVIS_BRANCH = "develop" ]]; then
            gradlew uploadArchives -PossrhUsername="$OSSRH_USERNAME" -PossrhPassword="$OSSRH_PASSWORD"
          fi
        else
          echo "Some Failed"
        fi
      fi

after_failure:
  - python travis_after_all.py
  - export $(cat .to_export_back)
  - |
      if [ "$BUILD_LEADER" = "YES" ]; then
        if [ "$BUILD_AGGREGATE_STATUS" = "others_failed" ]; then
          echo "All Failed"
        else
          echo "Some Failed"
        fi
      fi

after_script:
  - echo leader=$BUILD_LEADER status=$BUILD_AGGREGATE_STATUS

notifications:
  webhooks:
    urls:
      - secure: "PB66FfY2BALCDcwFHPxpKKn/sa9a9h7nd3Nqd8GCeWBkqEFK7bpdzMajcTKA3gEepbBy/dOMMXQ2ZjxVcs8ZCsVl6ywomBH6SXH+Qgmqjnu3bh/oXpF8Nmk86/5CsQhEfNVQJCBp6Tir33gQSDQs93BWUSyZ+s10gAAk4tXU83E="
    on_success: always
    on_failure: always
    on_start: false

deploy:
  provider: releases
  api-key:
    secure: "PfQLP01cnmTDN/vFgKuEgCZIbCLej1qHgE+6r5Q3MrMEYPzHTTN2cKizcEqtZ7LWth7e0XYnUyKBytg5kFzYBQl31fO/qhz5a5mf7OjuQbwmDFuJiElFafNX6NHpOx5O+wq7FHp2NzOsNiW27yD+12XgNjMkL27WBgRWsEWtuVA="
  file:
    - "build/libs/hearthmonitor-logapi-0.1.jar"
  skip_cleanup: true
  on:
    tags: true
    all_branches: true
    #must remain on all_branches: true together with tags: true due to the following bug: https://github.com/travis-ci/travis-ci/issues/1675
    #ideal situation would be to change it such that it only builds a release on the master branch on tag push

env:
  global:
    - secure: "TFx95nhSu5t+w37VJg0N4DgCVuVsJqJYdFjB0+z81Wt7PP2RJMTHrZbfS6y2RgVu1SPSoS854Rp1spHnMxkE5qwAZOZhe8/zN7Z3LBoskzoPNrMcJAr1BLVrKuz71UEa27lopfarF9S2vgKuYUeO+9vZLy924m4d3I6ELZUGIBo="
    - secure: "NALAo4hIyBltwNmNFoR/0hXpt/vHrImx6Hu5NDGcmcoDaYzwBOrt0iB2OF2CpuuaYRayQ7s7MOjOsSPx4xicHIQvaJEKw1n1/oHv2fyNOmwcC7+TeCEo/7fVrgAE1Fgu/+2XNMbNw/TafuruBtb9JNj7b89YCbVfOdPkZBR4gN8="